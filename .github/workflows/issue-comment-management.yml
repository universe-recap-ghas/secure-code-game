name: Issue and Comment Management

on:
  workflow_dispatch:
    inputs:
      issue_title:
        description: 'Title for the issue'
        required: false
        default: 'Automated Issue'
      issue_body:
        description: 'Body content for the issue'
        required: false
        default: 'This issue was created automatically by workflow dispatch.'
      commit_sha:
        description: 'Commit SHA to comment on'
        required: false
        default: ''
      comment_body:
        description: 'Comment to add on the commit'
        required: false
        default: 'Automated comment added by workflow.'

permissions:
  contents: write
  issues: write

jobs:
  manage-issue-and-comment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create Issue
        id: create-issue
        uses: tdupoiron/create-issue-action@v1
        with:
          title: ${{ github.event.inputs.issue_title }}
          body: ${{ github.event.inputs.issue_body }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add Comment to Commit
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          commit-id: ${{ github.event.inputs.commit_sha || github.sha }}
          body: ${{ github.event.inputs.comment_body }}
      
      - name: Close Issue with Octokit
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.number }};
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log(`âœ… Successfully closed issue #${issueNumber}`);
      
      - name: Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Issue Created:** #${{ steps.create-issue.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Issue URL:** ${{ steps.create-issue.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¬ **Comment added to commit:** \`${{ github.event.inputs.commit_sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **Issue Closed:** #${{ steps.create-issue.outputs.number }}" >> $GITHUB_STEP_SUMMARY
